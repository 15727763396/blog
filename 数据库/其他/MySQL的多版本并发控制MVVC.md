---
title: MySQL的多版本并发控制MVVC
date: 2020-06-01 16:56:24
tags: 数据库
---

## 什么是MVCC？

MVCC (Multi-Version Concurrency Control) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)是一种基于多版本的并发控制协议，只有在`InnoDB引擎`下存在。
MVCC是为了实现事务的隔离性，通过版本号，避免同一数据在不同事务间的竞争，你可以把它当成基于多版本号的一种`乐观锁`。当然，这种乐观锁只在事务级别`未提交锁`和`已提交锁`时才会生效。

MVCC最大的好处，相信也是耳熟能详：读不加锁，读写不冲突。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。具体见下面介绍。


## MVCC的实现机制

InnoDB在每行数据都增加两个隐藏字段，一个记录`创建版本号`，一个记录`删除版本号`。

而每一个事务在启动的时候，都有一个唯一的递增的版本号。 

在InnoDB中，给每行增加两个隐藏字段来实现MVCC，两个列都用来存储事务的版本号，每开启一个新事务，事务的版本号就会递增。

于是乎，默认的隔离级别（REPEATABLE READ）下，增删查改变成了这样：

**select：**

InnoDB必须每行数据来保证它符合两个条件：

- 　1、InnoDB必须找到一个行的版本，它至少要和事务的版本一样老(也即它的版本号不大于事务的版本号)。这保证了不管是事务开始之前，或者事务创建时，或者修改了这行数据的时候，这行数据是存在的。
- 　2、这行数据的删除版本必须是未定义的或者比事务版本要大。这可以保证在事务开始之前这行数据没有被删除。

符合这两个条件的行可能会被当作查询结果而返回。

**INSERT：**

　　InnoDB为这个新行记录当前的系统版本号。

**DELETE：**

　　InnoDB将当前的系统版本号设置为这一行的删除ID。

**UPDATE：**

　　InnoDB会写一个这行数据的新拷贝，这个拷贝的版本为当前的系统版本号。它同时也会将这个版本号写到旧行的删除版本里。

## 举例说明
在插入操作时 ： 记录的创建版本号就是事务版本号。 

比如我插入一条记录, 事务id 假设是1 ，那么记录如下：也就是说，创建版本号就是事务版本号。


id|	name|create version|delete version
---|---|---|---
1	| xielin |1	|  - 


在更新操作的时候，采用的是先标记旧的那行记录为已删除，并且删除版本号是事务版本号，然后插入一行新的记录的方式。 

比如，针对上面那行记录，事务Id为2 要把name字段更新。

```yaml
update table set name= 'new_value' where id=1;
```

id|	name|create version|delete version
---|---|---|---
1	| xielin |1	|  2
1    | new_value|2|-

> 此时一旦开始执行查询，就会应为事务版本为3而只查询出cv<=3 && (dv >3 or dv is null) 的范围数据，从而只查询出未删除数据

删除操作的时候，就把事务版本号作为删除版本号。比如：

```yaml
delete from table where id=1; 
```

id	|name|	create version|	delete version
---|---|---|---
1	|new_value|	2	|3


查询操作：从上面的描述可以看到，在查询时要符合以下两个条件的记录才能被事务查询出来： 

- 删除版本号 大于 当前事务版本号，就是说删除操作是在当前事务启动之后做的。 
- 创建版本号 小于或者等于 当前事务版本号 ，就是说记录创建是在事务中（等于的情况）或者事务启动之前。

这样就保证了各个事务互不影响。从这里也可以体会到一种提高系统性能的思路，就是：通过版本号来减少锁的争用。

- 只有read-committed和 repeatable-read 两种事务隔离级别才能使用MVCC 
- read-uncommited由于是读到未提交的，所以不存在版本的问题。而serializable 则会对所有读取的行加锁。 


## 悲观锁和乐观锁

- 悲观锁，正如它的名字那样，数据库总是认为别人会去修改它所要操作的数据，因此在数据库处理过程中将数据加锁。其实现依靠数据库底层。

- 乐观锁，如它的名字那样，总是认为别人不会去修改，只有在提交更新的时候去检查数据的状态。通常是给数据增加一个字段来标识数据的版本。