---
title: OAuth 2.0授权-深入理解（1）
date: 2019-03-07 19:56:24
tags: 
    - 单点登录
    - 协议
---
<meta name="referrer" content="no-referrer" />

## 背景

OAuth 2.0授权框架支持第三方应用程序以获取对HTTP服务的有限访问权通过协调批准交互来代表资源所有者在资源所有者和HTTP服务之间，或者通过允许第三方应用程序代表自己获取访问权限。

这个规范取代并淘汰了所描述的OAuth 1.0协议参考[RFC 5849](https://tools.ietf.org/html/rfc5849)

OAuth 2.0文档参考[RFC 6749](https://tools.ietf.org/html/rfc6749)

## 介绍

在传统的客户端-服务器身份验证模型中，客户端请求对服务器进行访问限制的资源（受保护的资源）通过使用资源所有者的服务器向服务器进行身份验证证书。
为了提供第三方应用程序访问受限制的资源，资源所有者与第三方。

这会带来一些问题和局限性：

- 需要第三方应用程序来存储资源所有者的凭证供将来使用，通常是密码明文
- 尽管要求服务器支持密码验证密码固有的安全性弱点
- 第三方应用程序获得了对资源的广泛访问所有者的受保护资源，从而使资源所有者一无所有限制持续时间或访问有限子集的能力资源。
- 损害任何第三方应用程序会导致以下方面的损害最终用户的密码以及受该密码保护的所有数据密码

 OAuth通过引入授权层解决了这些问题并将客户的角色与资源的角色分开所有者。
 
 在OAuth中，客户端请求访问受控资源由资源所有者并由资源服务器托管，并且是发行了与资源不同的一组凭证，而不是使用资源所有者的凭据来访问受保护的资源。
 
       客户端获得访问令牌-表示字符串的字符串具体范围，生存期和其他访问属性。
       访问令牌由授权服务器向第三方客户端颁发资源所有者的批准。
       客户端使用访问令牌来访问资源服务器托管的受保护资源。

例如，最终用户（资源所有者）可以授予打印权服务（客户端）访问存储在照片中的受保护照片-共享服务（资源服务器），而不共享她的用户名和打印服务的密码。

相反，她进行身份验证直接通过照片共享服务信任的服务器（授权服务器），它发出打印服务委托-特定凭证（访问令牌）。

## 角色
OAuth定义了四个角色：

       资源所有者：能够授予对受保护资源的访问权限的实体。当资源所有者是一个人时，它被称为最终用户。
       资源服务器：托管受保护资源的服务器，能够接受并使用访问令牌响应受保护的资源请求。
       客户：代表提出受保护资源请求的应用程序。
       授权服务器：成功后，服务器向客户端发布访问令牌，对资源所有者进行身份验证并获得授权。

## 协议流程

```yaml
     +--------+                               +---------------+
     |        |--(A)- Authorization Request ->|   Resource    |
     |        |                               |     Owner     |
     |        |<-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant -->| Authorization |
     | Client |                               |     Server    |
     |        |<-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------>|    Resource   |
     |        |                               |     Server    |
     |        |<-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
```

图1所示的抽象OAuth 2.0流程描述了
   四个角色之间的交互，包括以下步骤：

   （A）客户端请求资源所有者的授权请求可以直接向资源所有者提出（如图所示），或者最好间接通过授权服务器作为中介。

   （B）客户机收到一个授权授权，它是表示资源所有者授权的凭据，使用下面定义的**四种授权方式**之一表示指定或使用扩展授权类型。
   >这个授权授予类型取决于请求授权的客户端和授权服务器。

   （C）客户端通过向客户端进行身份验证来请求访问令牌授权服务器并显示授权授权。

   （D）授权服务器对客户端进行身份验证并验证授权授予，如果有效，则颁发访问令牌。
   
   （E）客户端从资源请求受保护的资源,服务器并通过提供访问令牌进行身份验证。
   
   （F）资源服务器验证访问令牌，如果有效，服务请求。
   

## 授权方式
授权授予是代表资源的凭证 所有者使用的所有者授权（访问其受保护的资源）客户端获取访问令牌。本规范定义了四个授予类型

（1）授权码
（2）隐式
（3）资源所有者密码凭证
（4）客户端凭证

### 授权码凭证

使用授权服务器获取授权代码作为客户机和资源所有者之间的中介而不是直接从资源所有者客户端请求授权
将资源所有者定向到授权服务器（通过[RFC2616](https://tools.ietf.org/html/rfc2616)中定义的用户代理，它反过来指导资源所有者使用授权代码返回到客户端。
在使用授权代码，授权服务器验证资源所有者并获得授权。因为资源所有者仅使用授权服务器、资源进行身份验证所有者的凭据从不与客户端共享。


授权码提供了一些重要的安全好处，

- 验证客户机的能力，以及将访问令牌直接传输到客户端
- 通过资源所有者的用户代理传递将它暴露给其他人，包括资源所有者。

### 隐式凭证

隐式授权是经过优化的简化授权代码流

对于在浏览器中使用脚本语言实现的客户端，作为JavaScript在隐式流中，而不是发出客户端一个授权码，客户端直接被颁发一个访问令牌（作为资源所有者授权的结果）。
授权类型是隐式的，因为没有中间凭据（例如授权代码）被发出（稍后用于获取访问令牌）。

在隐式授权流期间发出访问令牌时授权服务器不验证客户端。
在一些在某些情况下，可以通过重定向uri验证客户端身份，用于将访问令牌传递到客户端

访问令牌可以向资源所有者或其他有权访问资源所有者的用户代理。

### 资源所有者密码凭证

资源所有者密码凭据（即用户名和密码）可直接用作获得访问权限的授权授予访问令牌。
只有在存在高资源所有者和客户端之间的信任度（例如客户机是设备操作系统的一部分或具有高权限）当其他授权授予类型不是可用的（如授权码）。


即使此授权类型要求客户端直接访问资源所有者凭据，使用资源所有者凭据用于单个请求，并交换为访问令牌。
这个授权类型可以消除客户端存储通过交换具有长期访问令牌或刷新令牌的凭据。

###  客户端凭据

客户端凭据（或其他形式的客户端身份验证）可以当授权范围为仅限于受客户端控制的受保护资源，或对先前经授权安排的受保护资源服务器。

客户端凭据用作授权授予通常当客户代表自己行事时（客户是也是资源所有者）或正在请求访问受保护的基于先前与授权服务器。

## 访问令牌

访问令牌是用于访问受保护资源的凭据。一个访问令牌是表示颁发给客户端的授权的字符串。字符串对客户端通常是不透明的。令牌表示特定的访问范围和持续时间，由资源所有者授予，并由资源服务器和授权服务器强制执行。

令牌可以表示用于检索授权信息的标识符，或者可以可验证的方式自包含授权信息（即，由一些数据和签名组成的令牌字符串）。为了使客户端使用令牌，可能需要额外的身份验证凭据，这些凭据超出了本规范的范围。

访问令牌提供了一个抽象层，用资源服务器可以理解的单个令牌替换不同的授权结构（例如用户名和密码）。这种抽象使得发布访问令牌比用于获取它们的授权更具限制性，并且消除了资源服务器理解各种身份验证方法的需要。

根据资源服务器的安全要求，访问令牌可以具有不同的格式、结构和使用方法（例如，加密属性）访问令牌属性和用于访问受保护资源的方法超出了本规范的范围，并由配套规范（如[rfc6750]定义。

## 刷新令牌

刷新令牌是用于获取访问令牌的凭据刷新令牌由授权服务器颁发给客户端，用于在当前访问令牌无效或过期时获取新的访问令牌，或获取具有相同或更窄范围的其他访问令牌（访问令牌的生存期可能比资源所有者授权的短，权限也可能少）授权服务器可自行决定是否发出刷新令牌如果授权服务器发出刷新令牌，则在发出访问令牌时（即，图1中的步骤（D））包含该令牌。

刷新令牌是表示资源所有者授予客户端的授权的字符串。字符串对客户端通常是不透明的。令牌表示用于检索授权信息的标识符。与访问令牌不同，刷新令牌仅用于授权服务器，从不发送到资源服务器。


```yaml
  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant --------->|               |
  |        |                                           |               |
  |        |<-(B)----------- Access Token -------------|               |
  |        |               & Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token ----------->|               |
  |        |                                           |               |
  |        |<-(H)----------- Access Token -------------|               |
  +--------+           & Optional Refresh Token        +---------------+
```

    （A）客户机通过向授权服务器进行身份验证并提供授权授权来请求访问令牌。
    （B）授权服务器对客户端进行身份验证并验证授权授予，如果有效，则颁发访问令牌和刷新令牌。
    （C）客户端通过提供访问令牌向资源服务器发出受保护的资源请求。
    （D）资源服务器验证访问令牌，如果有效，则为请求提供服务。
    （E）重复步骤（C）和（D）直到访问令牌过期。如果客户端知道访问令牌已过期，它将跳到步骤（G）；否则，它将发出另一个受保护的资源请求。
    （F）由于访问令牌无效，资源服务器返回一个无效令牌错误。
    （G）客户端通过向授权服务器进行身份验证并呈现刷新令牌来请求新的访问令牌。客户端身份验证要求基于客户端类型和授权服务器策略。
    （H）授权服务器对客户端进行身份验证并验证刷新令牌，如果有效，则颁发新的访问令牌（以及可选的新刷新令牌）