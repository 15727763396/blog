---
title: 以太坊开发入门指南
date: 2019-07-03 19:56:24
tags: 
    - 区块链
    - 智能合约
---
<meta name="referrer" content="no-referrer" />

## 以太坊是什么

以太坊（Ethereum）是一个建立在区块链技术之上， 去中心化应用平台。它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。

在没有以太坊之前，写区块链应用是这样的：拷贝一份比特币代码，然后去改底层代码如加密算法，共识机制，网络协议等等（很多山寨币就是这样，改改就出来一个新币）。

以太坊平台对底层区块链技术进行了封装，让区块链应用开发者可以直接基于以太坊平台进行开发，只要专注于开发应用本身逻辑的智能合约，这样就可以大大降低开发难度。


## 智能合约

那么什么是智能合约呢？以太坊网络上运行程序就称之为智能合约， 它和其他的程序一样，也是代码和数据(状态)的集合。

智能合约（Smart Contract）和人工智能（Artificial Intelligence ）的智能没有关系，智能合约最早尼克萨博在 95 年就提出，它的概念很简单，就是将法律条文写成可执行代码。  
让法律条文的执行中立化，这个理念和区块链上的程序可以不被篡改、不被干预（只有有人触发交易，它将自动执行）的执行不谋而合，因此区块链引入了这个概念。

智能合约非常适合对信任、安全和持久性要求较高的应用场景，比如：数字货币、数字资产、投票、保险、金融应用、预测市场、产权所有权管理、物联网、点对点交易等等。  
目前除数字货币之外，真正落地的应用还不多（就像移动平台刚开始出来一样），相信 1 到 3 年内，各种杀手级会慢慢出现。


## 编程语言：Solidity

智能合约现在的主要编程语言是 Solidity 和 Vyper ，Solidity 更为成熟一些，Solidity 合约文件扩展名是 .sol ，虽然是一门新语言，但是但是他和大家常用的现代语言很相似，以下就是一个简单的计数器智能合约：

```js
pragma solidity >=0.4.22 <0.6.0;
 // 用contract 关键字定义一个合约
contract Counter { 
    uint counter;

    function count() public {
        counter = counter + 1;
    }
}
```

如果上面的合约把 contract 改成 class ，就和其他语言里定义一个类一样了。 Solidity 是一门编译型语言，代码被编译为以太坊虚拟机字节码之后，再部署到以太坊网络。  
以太坊为我们提供了很好的工具来完成这项工作，比如：Remix 就是用来开发、编译、部署智能合约的 IDE，它还是一个基于浏览器的 Web IDE，下面是 Remix IDE 的一个截图。

![](https://img.learnblockchain.cn/2019/06/15613593398072.jpg)

Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。 了解更多 Solidity 知识，可以参考社区翻译的[Solidity 中文文档](https://learnblockchain.cn/docs/solidity/)。

## 运行环境：EVM

EVM（Ethereum Virtual Machine）以太坊虚拟机 用来执行以太坊上的交易，提供智能合约的运行环境。

```js
Solidity 之于 EVM，就像Java之于 JVM 的关系一样
```

以太坊虚拟机是一个隔离的环境，外部无法接触到在 EVM 内部运行的代码。而 EVM 运行在以太坊节点上，当我们把合约部署到以太坊网络上之后，合约就可以在以太坊网络中运行了。

## 合约的编译

以太坊虚拟机上运行的是合约的字节码形式，需要我们在部署之前先对合约进行编译，可以选择Remix 或 solc 编译器。

## 合约的部署

在以太坊上开发应用时，常常要使用到以太坊客户端（钱包）。平时我们在开发中，一般不接触到客户端或钱包的概念，它是什么呢？

### 以太坊客户端（钱包）

以太坊客户端，其实我们可以把它理解为一个开发者工具，它提供账户管理、挖矿、转账、智能合约的部署和执行等等功能。

```js
EVM 是由以太坊客户端提供的
```

```js
Geth是典型的开发以太坊时使用的客户端，基于 Go 语言开发。 Geth提供了一个交互式命令控制台，通过命令控制台中包含了以太坊的各种功能（API）。
Geth 的使用我们之后会有文章介绍，这里大家先有个概念。
```

### 如何部署
智能合约的部署是指把合约字节码发布到区块链上，并使用一个特定的地址来标示这个合约，这个地址称为合约账户。

以太坊中有两类账户：

- 外部账户
该类账户被私钥控制（由人控制），没有关联任何代码。
- 合约账户
该类账户被它们的合约代码控制且有代码与之关联。

```js
外部账户与合约账户的区别和关系是这样的：一个外部账户可以通过创建和用自己的私钥来对交易进行签名，来发送消息给另一个外部账户或合约账户。
```

合约部署就是将编译好的合约字节码通过外部账号发送交易的形式部署到以太坊区块链上

### 运行

合约部署之后，当需要调用这个智能合约的方法时只需要向这个合约账户发送消息（交易）即可，通过消息触发后智能合约的代码就会在 EVM 中执行了。

## Gas

和云计算相似，占用区块链的资源（不管是简单的转账交易，还是合约的部署和执行）同样需要付出相应的费用（天下没有免费的午餐对不对！）。

以太坊上用 Gas 机制来计费，Gas 也可以认为是一个工作量单位，智能合约越复杂（计算步骤的数量和类型，占用的内存等），用来完成运行就需要越多 Gas。

任何特定的合约所需的运行合约的 Gas 数量是固定的，由合约的复杂度决定。
而 Gas 价格由运行合约的人在提交运行合约请求的时候设定，以确定他愿意为这次交易愿意付出的费用：Gas 价格（用以太币计价） * Gas 数量。

Gas 的目的是限制执行交易所需的工作量，同时为执行支付费用。当 EVM 执行交易时，Gas 将按照特定规则被逐渐消耗，无论执行到什么位置，一旦 Gas 被耗尽，将会触发异常。当前调用帧所做的所有状态修改都将被回滚， 如果执行结束还有 Gas 剩余，这些 Gas 将被返还给发送账户。

```js
如果没有这个限制，就会有人写出无法停止（如：死循环）的合约来阻塞网络。
```

因此实际上（把前面的内容串起来），我们需要一个有以太币余额的外部账户，来发起一个交易（普通交易或部署、运行一个合约），运行时，矿工收取相应的工作量费用。

## 以太坊网络

### Testnet

以太坊官网测试网络 Testnet，测试网络中，我们可以很容易获得免费的以太币，缺点是需要发很长时间初始化节点。

 ### 使用私有链
创建自己的以太币私有测试网络，通常也称为私有链，我们可以用它来作为一个测试环境来开发、调试和测试智能合约。  
通过上面提到的 Geth 很容易就可以创建一个属于自己的测试网络，以太币想挖多少挖多少，也免去了同步正式网络的整个区块链数据。

### 使用开发者网络(模式)

相比私有链，开发者网络(模式)下，会自动分配一个有大量余额的开发者账户给我们使用。

### 使用模拟环境

另一个创建测试网络的方法是使用 Ganache，Ganache 是普通的应用程序，它在本地使用内存模拟的一个以太坊区块链环境，对于开发调试来说，更方便快捷。  
而且 Ganache 会在启动时帮我们创建 10 个存有资金的测试账户。
进行合约开发时，可以在 Ganache 中测试通过后，再部署到 Geth 节点中去。

## DApp：去中心化的应用程序

以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。如果我们把区块链理解为一个不可篡改的数据库，智能合约理解为和数据库打交道的程序，那就很容易理解 DApp 了。  
一个 DApp 不单单有智能合约（相当于应用的后台），比如还需要有一个友好的用户界面。 

## Truffle

[Truffle](https://learnblockchain.cn/docs/truffle/)是一个非常流行 DApp 开发框架，他可以帮我们处理掉大量无关紧要的小事情，让我们可以迅速开始写代码-编译-部署-测试-打包 DApp 这个流程。

## 总结

我们现在来总结一下，
- 以太坊是平台，它让我们方便的使用区块链技术开发去中心化的应用.
- 在这个应用中，使用 Solidity 来编写和区块链交互的智能合约.
- 合约编写好后之后，我们需要用以太坊客户端用一个有余额的账户去部署及运行合约（使用Truffle可以更好的帮助我们做这些事情了）。
- 为了开发方便，我们可以用 Geth 或 Ganache 来搭建一个测试网络。
 
