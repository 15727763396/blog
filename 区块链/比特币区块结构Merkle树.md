---
title: 比特币区块结构Merkle树
date: 2019-06-27 19:56:24
tags: 
    - 区块链
---
<meta name="referrer" content="no-referrer" />
## 前言

在比特币网络中，不是每个节点都有能力储存完整的区块链数据，受限于存储空间的的限制，很多节点是以 SPV（Simplified Payment Verification 简单支付验证）钱包接入比特币网络，通过简单支付验证可以在不必存储完整区块链下对交易进行验证，本文将分析区块结构 Merkle 树及如何进行交易验证。

## 区块结构

![](https://img.learnblockchain.cn/2017/block_structure.jpeg!wl)

如上图（下文称：区块结构图）所示：每个数据区块包含区块头和区块体。  
- 区块头封装了当前版本号、前一区块哈希值、当前区块 PoW 要求的随机数(Nonce)、时间戳、以及 Merkle 根信息。
- 区块体则包括当前区块经过验证的、 区块创建过程中生成的所有交易记录。这些记录通过 Merkle 树的哈希过程生成唯一的 Merkle 根并记入区块头。

```json
区块哈希值实际上并不包含在区块的数据结构里，其实区块打包时只有区块头被用于计算哈希（从网络被接收时由每个节点计算出来），常说的区块哈希值实际是区块头哈希值，它可以用来唯一、明确地标识一个区块。
```

区块头是 80 字节，而平均每个交易至少是 250 字节，而且平均每个区块包含 2000 个交易。因此，包含完整交易的区块比区块头的 4 千倍还要大。  
SPV 节点只下载区块头，不下载包含在每个区块中的交易信息。这样的不含交易信息的区块链，大小只有完整区块链的几千分之 1，那 SPV 节点是如何验证交易的呢？

## 哈希验证

```json
原始信息任何微小的变化都会哈希完全不同的哈希值
```

### 简单文件验证
我们通常用哈希来检验下载的文件是否完整，我经常看到这样的下载页面：

![](https://img.learnblockchain.cn/2017/ex_check_file.jpeg!wl)

可以看到下载链接后面提供了一个 MD5（MD5 也是一种 Hash 算法），这样我们可以在下载之后对文件计算 MD5，如果 MD5 与提供的 MD5 相等，说明文件有没有被损坏，这个验证过程相信大家都能理解。

### 多点文件验证(哈希列表)

现在复杂度提高一点，在 P2P 网络中下载时，会把大文件切成小文件，同时从多个机器上下载数据，这个时候怎么验证数据呢？

以 BT 下载为例，在下载真正的数据之前，我们会先下载一个哈希列表的（每个下小块计算出一个哈希），如果有一个小块数据在传输过程中损坏了，那我只要重新下载这一个数据块就行了，这时有一个问题就出现了，那么多的哈希，怎么保证它们本身(哈希列表中的哈希值)都是正确地呢？

答案是把每个小块数据的哈希值拼到一起，然后对这个长字符串在作一次哈希运算，得到哈希列表的根哈希。只要根哈希校对比一样就说明验哈希列表是正确的，再通过哈希列表校验小数据块，如果所有的小数据块验证通过则说明大文件没有被损坏。

## Merkle树

在分布式系统、P2P应用中或者是区块链中，会经常使用一种数据结构Merkle tree（默克尔树）.Merkle树看起来非常像二叉树，其叶子节点上的值通常为数据块的哈希值，而非叶子节点上的值，所以有时候Merkle tree也表示为Hash tree，如下图所示：

![](https://user-gold-cdn.xitu.io/2019/7/11/16bdf02919144078?w=1920&h=1222&f=png&s=71999)

在构造Merkle树时，首先要对数据块计算哈希值，通常，选用SHA-256等哈希算法。但如果仅仅防止数据不是蓄意的损坏或篡改，可以改用一些安全性低但效率高的校验和算法，如CRC。然后将数据块计算的哈希值两两配对（如果是奇数个数，最后一个自己与自己配对），计算上一层哈希，再重复这个步骤，一直到计算出根哈希值。

Merkle树大多用来进行完整性验证，比如分布式环境下，从多台主机获取数据，怎么验证获取的数据是否正确呢，只要验证Merkle树根哈希一致，即可。  

```json
可以说，任何底层数据块的变化，最终都会传导到根哈希。
另外如果根哈希不一致，也可以通过Merkle树快速定位到导致不一致的数据。(基于二叉树结构，查找错误的数据的时间负责度为定位过程的算法复杂度为O(log(n))
```

在区块链结构中每个叶子节点是每个交易信息的哈希，往上对相邻的两个哈希合并成字符串再哈希，继续类似的操作直到只剩下顶部的一个节点，即 Merkle 根，存入区块头。

## 简化支付验证

SPV 节点不保存所有交易也不会下载整个区块，仅仅保存区块头，我们来看看它是如何对交易数据进行验证的。

假如要验证区块结构图中交易 6，SPV 节点会通过向相邻节点索要（通过 Merkleblock 消息）包括从交易 6 哈希值沿 Merkle 树上溯至区块头根哈希处的哈希序列 (即哈希节点 6, 5, 56, 78, 5678, 1234 1~8 - 称为认证路径) 来确认交易的存在性和正确性。（在 N 个交易组成的区块中确认任一交易只需要计算 log2(N)个字节的哈希值，非常快速高效）
